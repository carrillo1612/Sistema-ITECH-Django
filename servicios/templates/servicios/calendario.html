{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Calendario de Servicios | ITECH</title>
    
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        primary: '#0F172A',
                        accent: '#2563EB',
                    }
                }
            }
        }
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/locales-all.global.min.js"></script>

    <style>
        /* Estilos Base */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .smooth-scroll { -webkit-overflow-scrolling: touch; }

        /* Calendario */
        #calendar {
            background: #fff;
            padding: 0.5rem;
            border-radius: 0.75rem; 
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            min-height: 600px;
        }
        @media (min-width: 768px) { #calendar { padding: 1.5rem; } }
        
        .fc .fc-toolbar-title { font-size: 1.1rem; font-weight: 700; color: #1e293b; }
        @media (min-width: 768px) { .fc .fc-toolbar-title { font-size: 1.5rem; } }

        .fc-toolbar-chunk button {
            background-color: #2563EB !important; border-color: #2563EB !important; color: #fff !important;
            border-radius: 0.375rem !important; padding: 0.4rem 0.6rem !important; font-size: 0.8rem !important;
            font-weight: 500 !important; text-transform: capitalize !important; opacity: 1 !important;
        }
        .fc-toolbar-chunk button:hover { background-color: #1d4ed8 !important; border-color: #1d4ed8 !important; }
        .fc-toolbar-chunk button.fc-button-active { background-color: #1e40af !important; border-color: #1e40af !important; }
        .fc-today-button { background-color: #64748b !important; border-color: #64748b !important; }

        /* Tooltip */
        .event-tooltip {
            position: absolute; top: 0; left: 0; z-index: 9999; width: 280px;
            background: rgba(15, 23, 42, 0.95); color: white; padding: 15px; 
            border-radius: 8px; pointer-events: none; font-size: 0.85rem; display: none; 
            backdrop-filter: blur(4px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }
        
        /* Modal Cargando */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; 
            background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(2px);
            justify-content: center; align-items: center; padding: 1rem;
        }
        .modal[style*="display: block"], .modal[style*="display: flex"] { display: flex !important; }
    </style>
</head>

<body class="bg-slate-100 text-slate-800 h-[100dvh] flex flex-col overflow-hidden font-sans">

    <nav class="bg-white border-b border-slate-200 h-16 flex items-center justify-between px-4 sm:px-6 shadow-sm z-30 shrink-0">
        <div class="flex items-center gap-3">
            <button id="mobile-menu-btn" class="lg:hidden text-slate-500 hover:text-slate-700 focus:outline-none p-2">
                <i class="fas fa-bars text-xl"></i>
            </button>
                <div class="flex items-center gap-4">
            <div class="flex items-center gap-2">
                <img src="{% static 'img/logo.jpeg' %}" alt="Logo" class="h-8 w-auto object-contain">
                <span class="font-bold text-xl tracking-tight text-slate-900">ITECH</span>
            </div>
            <div class="hidden md:flex h-6 w-px bg-slate-300 mx-2"></div>
            <span class="hidden md:block text-xs font-medium text-slate-500 bg-slate-100 px-2 py-1 rounded-full border border-slate-200">
                <i class="fas fa-headset mr-1"></i> Soporte: +52 933 112 9250
            </span>
        </div>
        <div class="flex items-center gap-3">
            <div class="text-right hidden sm:block">
                <p class="text-sm font-semibold text-slate-700">{{ user.Nombre }} {{ user.Apellido }}</p>
                <p class="text-xs text-slate-500">{{ user.Rol }}</p>
            </div>
            <div class="h-9 w-9 bg-accent/10 rounded-full flex items-center justify-center text-accent font-bold border border-accent/20">
                {{ user.Nombre|slice:":1" }}{{ user.Apellido|slice:":1" }}
            </div>
            <a href="{% url 'logout' %}" class="ml-2 text-red-500 hover:text-red-700 hover:bg-red-50 p-2 rounded-full transition-colors">
                <i class="fas fa-sign-out-alt text-lg"></i>
            </a>
        </div>
    </nav>

    <div class="flex flex-1 overflow-hidden relative">
        
        <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-20 hidden lg:hidden transition-opacity opacity-0" onclick="toggleSidebar()"></div>

        <aside id="sidebar" class="fixed inset-y-0 left-0 w-64 bg-slate-900 text-slate-300 flex-col shadow-xl z-40 transform -translate-x-full transition-transform duration-300 lg:translate-x-0 lg:static lg:flex h-[100dvh] lg:h-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6 lg:hidden">
                    <span class="text-white font-bold text-lg">Menú</span>
                    <button onclick="toggleSidebar()" class="text-slate-400 hover:text-white p-2">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <p class="text-xs uppercase tracking-wider text-slate-500 font-bold mb-4 hidden lg:block">Menú Principal</p>
                <nav class="space-y-1">
                    <a href="{% url 'vista_calendario' %}" class="flex items-center gap-3 px-4 py-3 rounded-lg bg-slate-800 text-white border-r-4 border-accent transition-all group">
                        <i class="fas fa-calendar-alt w-5 text-center text-accent transition-colors"></i> Calendario
                    </a>
                    
                    <a href="{% url 'lista_ordenes' %}" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-800 hover:text-white transition-all group">
                        <i class="fas fa-file-invoice w-5 text-center group-hover:text-accent transition-colors"></i> Órdenes
                    </a>

                    {% if request.user.Rol == 'Administrador' or request.user.Rol == 'Técnico' %}
                    <a href="{% url 'lista_reportes_pendientes' %}" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-800 hover:text-white transition-all group">
                        <i class="fas fa-tools w-5 text-center group-hover:text-accent transition-colors"></i> Generar Reporte
                    </a>
                    {% endif %}

                    {% if request.user.Rol == 'Administrador' %}
                    <a href="{% url 'lista_clientes' %}" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-800 hover:text-white transition-all group">
                        <i class="fas fa-users w-5 text-center group-hover:text-accent transition-colors"></i> Clientes
                    </a>
                    <a href="{% url 'gestion_usuarios' %}" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-800 hover:text-white transition-all group">
                        <i class="fas fa-user-cog w-5 text-center group-hover:text-accent transition-colors"></i> Usuarios
                    </a>
                    {% endif %}
                </nav>
            </div>
            <div class="mt-auto p-6 border-t border-slate-800">
                <p class="text-xs text-center text-slate-600">&copy; 2024 ITECH System</p>
            </div>
        </aside>

        <main class="flex-1 flex flex-col min-w-0 bg-slate-50/50 w-full h-full relative">
            
            <div class="px-4 sm:px-8 py-6 pb-2 shrink-0 bg-slate-50 z-10">
                <div class="flex items-center gap-3 mb-1">
                    <div class="p-2 bg-blue-100 text-accent rounded-lg">
                        <i class="fas fa-calendar-check text-xl"></i>
                    </div>
                    <h1 class="text-xl sm:text-2xl font-bold text-slate-800">Calendario de Servicios</h1>
                </div>
                <p class="text-slate-500 text-xs sm:text-sm ml-0 sm:ml-12 mt-2 sm:mt-0">Visualiza y gestiona la programación.</p>
            </div>

            <div class="flex-1 p-4 sm:p-6 sm:px-8 pt-2 overflow-y-auto smooth-scroll custom-scrollbar pb-24 flex flex-col">
                
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-6">
                    <div class="flex flex-col lg:flex-row gap-4 items-end justify-between">
                        
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 w-full lg:w-auto flex-1">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Cliente</label>
                                <select id="filter_cliente" class="w-full p-2 border border-slate-300 rounded-lg text-sm focus:border-accent focus:outline-none bg-white">
                                    <option value="Todos" selected>Todos los Clientes</option>
                                    {% for cliente in clientes %}
                                        <option value="{{ cliente.ClienteID }}">{{ cliente.NombreComercial }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Técnico</label>
                                <select id="filter_personal" class="w-full p-2 border border-slate-300 rounded-lg text-sm focus:border-accent focus:outline-none bg-white">
                                    <option value="Todos" selected>Todo el Personal</option>
                                    {% for p in personal %}
                                        <option value="{{ p.UsuarioID }}">{{ p.Nombre }} {{ p.Apellido }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Estado</label>
                                <select id="filter_estado_orden" class="w-full p-2 border border-slate-300 rounded-lg text-sm focus:border-accent focus:outline-none bg-white">
                                    <option value="Todos">Todos</option>
                                    <option value="Pendiente">Pendiente</option>
                                    <option value="Terminada">Terminada</option>
                                </select>
                            </div>
                            <input type="hidden" id="filter_estado_actividad" value="Todos">
                        </div>

                        <div class="flex gap-2 w-full lg:w-auto justify-end lg:justify-start mt-2 lg:mt-0">
                            <button id="btn_nueva" class="w-full sm:w-auto bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition shadow-sm flex items-center justify-center gap-2">
                                <i class="fas fa-plus"></i> Nueva Actividad
                            </button>
                            <button id="btn_xls" class="bg-cyan-500 hover:bg-cyan-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition shadow-sm hidden sm:flex">
                                <i class="fas fa-file-excel"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div id="calendar"></div>
                <div class="h-10 lg:hidden"></div>

            </div>
        </main>
    </div>

    <script>
    const PDF_URL_BASE = "{% url 'ver_reporte' 0 %}";
    const EDIT_URL_BASE = "{% url 'editar_orden' 0 %}";
    const REGISTRO_URL_BASE = "{% url 'registro_temp' 0 %}";
    const userRole = "{{ user.Rol }}";

    document.addEventListener('DOMContentLoaded', function () {

        const calendarEl = document.getElementById('calendar');
        const btnNueva = document.getElementById('btn_nueva');
        
        // 1. Menú Móvil
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        const btnMenu = document.getElementById('mobile-menu-btn');
        const btnCloseSidebar = document.getElementById('close-sidebar-btn');

        function toggleMenu() {
            const isClosed = sidebar.classList.contains('-translate-x-full');
            if (isClosed) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
                setTimeout(() => overlay.classList.remove('opacity-0'), 10);
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('opacity-0');
                setTimeout(() => overlay.classList.add('hidden'), 300);
            }
        }
        if(btnMenu) btnMenu.addEventListener('click', toggleMenu);
        if(btnCloseSidebar) btnCloseSidebar.addEventListener('click', toggleMenu);
        if(overlay) overlay.addEventListener('click', toggleMenu);

        // 2. Tooltip
        const tooltip = document.createElement('div');
        tooltip.className = 'event-tooltip'; 
        document.body.appendChild(tooltip);

        // 3. REDIRECCIÓN DEL BOTÓN "NUEVA ACTIVIDAD" (MODIFICADO)
        // Ahora redirige directamente a la lista de reportes pendientes
        if(btnNueva){
            btnNueva.addEventListener('click', () => {
                window.location.href = "{% url 'lista_reportes_pendientes' %}";
            });
        }

        // 4. FullCalendar
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'es',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
            },
            buttonText: {
                today: 'Hoy', month: 'Mes', week: 'Semana', day: 'Día', list: 'Lista'
            },
            height: 'auto', 
            contentHeight: 'auto',

            windowResize: function(view) {
                const screenWidth = window.innerWidth;
                if (screenWidth < 640) {
                    if(calendar.view.type !== 'listWeek') {
                        calendar.changeView('listWeek');
                    }
                } else {
                    if(calendar.view.type === 'listWeek') {
                        calendar.changeView('dayGridMonth');
                    }
                }
            },

            events: {
                url: "{% url 'calendario_data' %}",
                method: 'GET',
                extraParams: function () {
                    return {
                        cliente: document.getElementById('filter_cliente').value,
                        personal: document.getElementById('filter_personal').value,
                        estado_orden: document.getElementById('filter_estado_orden').value,
                    };
                },
                failure: function () {
                    alert('Hubo un error al cargar las órdenes.');
                }
            },

            eventDidMount: function (info) {
                if (window.matchMedia("(min-width: 1024px)").matches) {
                    info.el.addEventListener('mouseenter', function () {
                        const props = info.event.extendedProps;
                        tooltip.innerHTML = `
                            <span class="tooltip-title">${info.event.title}</span>
                            <span style="font-weight: bold; display: block; margin-bottom: 5px; color: #e2e8f0;">
                                <i class="fas fa-user-circle"></i> ${props.cliente_nombre || 'N/A'}
                            </span>
                            <hr style="border-top: 1px solid #475569; margin: 8px 0;">
                            <span class="tooltip-label"><i class="fas fa-phone-alt"></i> ${props.telefono || 'N/A'}</span>
                            <span class="tooltip-label"><i class="fas fa-map-marker-alt"></i> ${props.ubicacion || 'N/A'}</span>
                            <span class="tooltip-label"><i class="fas fa-hard-hat"></i> ${props.asignado || 'N/A'}</span>
                            <span class="tooltip-label" style="font-weight: bold; color: #4ade80; margin-top: 10px; text-transform: uppercase;">
                                ${props.estado_orden || 'N/A'}
                            </span>
                        `;
                        tooltip.style.display = 'block';
                        const rect = info.el.getBoundingClientRect();
                        tooltip.style.left = (rect.left + rect.width / 2) + 'px';
                        tooltip.style.top = (rect.bottom + 5) + 'px';
                        tooltip.style.transform = 'translateX(-50%)';
                    });
                    info.el.addEventListener('mouseleave', function () {
                        tooltip.style.display = 'none';
                    });
                }
            },

            eventClick: function (info) {
                info.jsEvent.preventDefault();
                const ordenID = info.event.id;
                const estado = info.event.extendedProps.estado_orden;
                
                if (estado === 'Terminada' || estado === 'Completada') {
                    const pdfUrl = PDF_URL_BASE.replace('0', ordenID);
                    window.open(pdfUrl, '_blank');
                } else if (userRole === 'Administrador') {
                    const editUrl = EDIT_URL_BASE.replace('0', ordenID);
                    window.location.href = editUrl;
                } else if (estado === 'Pendiente' || estado === 'Activa' || estado === 'En Proceso') {
                    if (userRole === 'Técnico') {
                        const urlRegistro = REGISTRO_URL_BASE.replace('0', ordenID);
                        if (confirm(`La Orden #${ordenID} está PENDIENTE.\n\n¿Deseas ir ahora a GENERAR EL REPORTE TÉCNICO?`)) {
                            window.location.href = urlRegistro;
                        }
                    } else {
                        alert(`⚠️ La Orden #${ordenID} está en estado: ${estado}.`);
                    }
                } else if (info.event.url) {
                    window.location.href = info.event.url; 
                }
            },
            editable: false
        });

        calendar.render();

        ['filter_cliente', 'filter_personal', 'filter_estado_orden'].forEach(id => {
            const filterElement = document.getElementById(id);
            if (filterElement) {
                filterElement.addEventListener('change', () => calendar.refetchEvents());
            }
        });
    });
    </script>
</body>
</html>