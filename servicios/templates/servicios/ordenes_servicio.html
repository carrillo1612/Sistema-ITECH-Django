{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Órdenes de Servicio | ITECH</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: '#0F172A', // Azul oscuro elegante
                        accent: '#2563EB',  // Azul brillante para acciones
                    }
                }
            }
        }
    </script>

    <style>
        /* Mantenemos tus variables para los componentes internos */
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --info-color: #17a2b8;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --light-bg: #f8f9fa;
            --text-color: #333;
            --border-color: #dee2e6;
            --white-color: #fff;
            --light-text-color: #fff;
        }

        /* Ajustes para Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* --- TUS ESTILOS DE FILTROS Y TABLA (INTACTOS) --- */
        .filter-toolbar {
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            border: 1px solid #e2e8f0; /* Ajustado a Tailwind slate-200 */
        }

        .filter-row { display: flex; gap: 20px; margin-bottom: 15px; }
        .filter-group { flex: 1; display: flex; align-items: center; gap: 5px; }
        .filter-group label { font-size: 0.9em; color: #555; white-space: nowrap; }
        .filter-group select, .filter-group input[type="date"] {
            flex: 1; padding: 8px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9em; min-width: 0;
        }
        .filter-group input[type="date"] { width: 130px; }

        .action-toolbar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px; background-color: #fff;
            border: 1px solid #e2e8f0; border-radius: 8px 8px 0 0; margin-bottom: -1px;
        }
        .action-toolbar-left, .action-toolbar-right { display: flex; align-items: center; gap: 10px; }
        .action-toolbar select { padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9em; width: 60px; }
        .action-toolbar button { padding: 8px 15px; border-radius: 4px; border: none; cursor: pointer; font-size: 0.9em; color: #fff; font-weight: 600; }
        .action-toolbar #btn_nueva_orden { background-color: var(--primary-color); }
        .action-toolbar #btn_xls, .action-toolbar #btn_print { background-color: var(--secondary-color); }
        .action-toolbar .search-box {
            display: flex; align-items: center; border: 1px solid #ccc; border-radius: 4px; padding: 0 10px; background-color: #fff;
        }
        .action-toolbar .search-box input { padding: 8px 0; border: none; font-size: 0.9em; outline: none; width: 150px; }
        .action-toolbar .search-box i { color: #999; margin-right: 5px; }

        /* Tabla */
        .data-table-container {
            flex: 1; overflow: visible; background-color: #fff;
            border: 1px solid #e2e8f0; border-radius: 0 0 8px 8px;
        }
        .data-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .data-table th, .data-table td {
            padding: 12px 10px; text-align: left; border-bottom: 1px solid #eee;
            font-size: 0.85em; overflow: hidden; text-overflow: ellipsis;
        }
        .data-table th { background-color: #f8fafc; color: #64748b; font-weight: 600; } /* Ajustado a colores slate */
        .data-table tr:hover { background-color: #f0f8ff; }

        /* Acciones de fila */
        .action-cell { position: relative; text-align: center; }
        .row-action-btn { background: none; border: none; color: #666; cursor: pointer; font-size: 1.1em; padding: 5px; }
        .row-action-btn:hover { color: var(--primary-color); }
        
        /* Dropdown Menu */
        .dropdown-menu {
            position: absolute; top: 100%; left: 50%; transform: translateX(-50%);
            z-index: 50; background-color: #fff; min-width: 150px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); border-radius: 4px; padding: 5px 0; display: none;
        }
        .dropdown-menu.show { display: block; }
        .dropdown-item {
            display: flex; align-items: center; padding: 8px 15px; text-decoration: none;
            color: var(--text-color); font-size: 0.9em; cursor: pointer; transition: background-color 0.1s;
        }
        .dropdown-item:hover { background-color: var(--light-bg); color: var(--primary-color); }
        .dropdown-item.delete:hover { color: var(--danger-color); background-color: #fcebeb; }

        /* Status Tags */
        .folio-cell { font-weight: bold; color: var(--primary-color); }
        .status-tag { display: inline-block; padding: 4px 8px; border-radius: 4px; font-weight: 600; font-size: 0.8em; text-transform: uppercase; }
        .status-terminada { background-color: #e6f7ff; color: #1890ff; }
        .status-pendiente { background-color: #fffbe6; color: #faad14; }
        .status-proceso { background-color: #f6ffed; color: #52c41a; }
        .pdf-download-btn { background: none; border: none; color: var(--primary-color); cursor: pointer; font-size: 1.1em; opacity: 0.7; transition: opacity 0.2s; }
        .pdf-download-btn:hover { opacity: 1; }

        /* --- ESTILOS DEL MODAL (INTACTOS) --- */
        .modal {
            display: none; position: fixed; z-index: 900; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            background-color: #f8f9fa; margin: 2% auto; padding: 1.5rem;
            width: 90%; max-width: 1400px; border-radius: 8px; position: relative;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        .modal-body { display: flex; gap: 2rem; }
        .modal .form-section { flex: 3; }
        .modal .card {
            background-color: #fff; padding: 1.5rem; border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05); margin-bottom: 1.5rem;
        }
        .modal .card h2 { margin-top: 0; font-size: 1.25rem; margin-bottom: 1rem;}
        .modal .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; }
        .modal .form-group { display: flex; flex-direction: column; }
        .modal .form-group label { margin-bottom: 0.5rem; font-size: 0.9rem; color: #555; font-weight: 600; }
        .modal .form-group input, .modal .form-group select, .modal .form-group textarea {
            width: 100%; padding: 0.75rem; border: 1px solid #dee2e6; border-radius: 4px; font-size: 1rem; box-sizing: border-box;
        }
        .modal .full-width { grid-column: span 2; }
        .modal .add-item-section { display: grid; grid-template-columns: 80px 1fr 1fr auto; gap: 1rem; align-items: flex-end; }
        .modal .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; font-weight: 600; text-align: center; }
        .modal .btn-primary { background-color: var(--primary-color); color: #fff; }
        .modal .actions-section { flex: 1; }
        .modal .actions-card .info-header { text-align: center; margin-bottom: 2rem; }
        .modal .actions-card .fa-calendar-day { font-size: 2.5rem; color: var(--primary-color); margin-bottom: 0.5rem; }
        .modal .actions-card .date { font-size: 1.2rem; font-weight: 600; }
        .modal .actions-card .info-tags { text-align: center; margin-bottom: 2rem; color: var(--secondary-color); font-size: 0.8rem; font-weight: 600; }
        .modal .actions-card .action-buttons { display: flex; flex-direction: column; gap: 0.75rem; }
        .modal .btn-success { background-color: #1abc9c; color: #fff; }
        .modal .btn-outline { background-color: transparent; color: var(--secondary-color); border: 1px solid #dee2e6; }
    </style>
</head>

<body class="bg-slate-100 text-slate-800 h-screen flex flex-col overflow-hidden font-sans">

    <nav class="bg-white border-b border-slate-200 h-16 flex items-center justify-between px-6 shadow-sm z-20 shrink-0">
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2">
                <img src="{% static 'img/logo.jpeg' %}" alt="Logo" class="h-8 w-auto object-contain">
                <span class="font-bold text-xl tracking-tight text-slate-900">ITECH</span>
            </div>
            <div class="hidden md:flex h-6 w-px bg-slate-300 mx-2"></div>
            <span class="hidden md:block text-xs font-medium text-slate-500 bg-slate-100 px-2 py-1 rounded-full border border-slate-200">
                <i class="fas fa-headset mr-1"></i> Soporte: +52 999 456 7891
            </span>
        </div>

        <div class="flex items-center gap-3">
            <div class="text-right hidden sm:block">
                <p class="text-sm font-semibold text-slate-700">{{ user.Nombre }} {{ user.Apellido }}</p>
                <p class="text-xs text-slate-500">{{ user.Rol }}</p>
            </div>
            <div class="h-10 w-10 bg-accent/10 rounded-full flex items-center justify-center text-accent font-bold border border-accent/20">
                {{ user.Nombre|slice:":1" }}{{ user.Apellido|slice:":1" }}
            </div>
        </div>
    </nav>

    <div class="flex flex-1 overflow-hidden">
        
        <aside class="w-64 bg-slate-900 text-slate-300 flex-shrink-0 hidden md:flex flex-col shadow-xl z-10">
            <div class="p-6">
                <p class="text-xs uppercase tracking-wider text-slate-500 font-bold mb-4">Menú Principal</p>
                <nav class="space-y-1">
    
                  <nav class="space-y-1">
    
    <a href="{% url 'vista_calendario' %}" 
       class="flex items-center gap-3 px-4 py-3 rounded-lg bg-slate-800 text-white border-r-4 border-accent transition-all group">
        <i class="fas fa-calendar-alt w-5 text-center text-accent transition-colors"></i> Calendario
    </a>

     <a href="{% url 'lista_ordenes' %}" 
       class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-800 hover:text-white transition-all group">
        <i class="fas fa-file-invoice w-5 text-center group-hover:text-accent transition-colors"></i> Órdenes
    </a>
    
    {% if request.user.Rol == 'Administrador' or request.user.Rol == 'Técnico' %}
    <a href="{% url 'lista_reportes_pendientes' %}" 
       class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-800 hover:text-white transition-all group">
        <i class="fas fa-tools w-5 text-center group-hover:text-accent transition-colors"></i> Generar Reporte
    </a>
    {% endif %}

    {% if request.user.Rol == 'Administrador' %}
    
    <a href="{% url 'lista_clientes' %}" 
       class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-800 hover:text-white transition-all group">
        <i class="fas fa-users w-5 text-center group-hover:text-accent transition-colors"></i> Clientes
    </a>


    <a href="{% url 'gestion_usuarios' %}" 
       class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-800 hover:text-white transition-all group">
        <i class="fas fa-user-cog w-5 text-center group-hover:text-accent transition-colors"></i> Usuarios
    </a>
    {% endif %}

</nav>
            </div>
            <div class="mt-auto p-6 border-t border-slate-800">
                <p class="text-xs text-center text-slate-600">&copy; 2024 ITECH System</p>
            </div>
        </aside>

        <main class="flex-1 flex flex-col min-w-0 bg-slate-50/50">
            
            <div class="px-8 py-6 pb-2 shrink-0">
                <div class="flex items-center gap-3 mb-1">
                    <div class="p-2 bg-blue-100 text-accent rounded-lg">
                        <i class="fas fa-file-invoice text-xl"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-slate-800">Gestión de Órdenes</h1>
                </div>
                <p class="text-slate-500 text-sm ml-12">Administra y filtra todas las órdenes de servicio.</p>
            </div>

            <div class="flex-1 p-6 sm:px-8 pt-4 overflow-y-auto custom-scrollbar">
                
               <div class="filter-toolbar">
                <a href="{% url 'lista_ordenes' %}" style="font-size: 0.8em; color: var(--primary-color); text-decoration: underline; cursor: pointer;">
    <i class="fas fa-sync"></i> Mostrar Todo
</a>
    <form method="GET" id="filterForm">
        
        <div class="filter-row">
            <div class="filter-group">
                <label for="date_start">Desde (programada)</label>
                <input type="date" name="date_start" id="date_start" 
                       value="{{ request.GET.date_start }}" 
                       onchange="this.form.submit()">
            </div>
            <div class="filter-group">
                <label for="date_end">Hasta (programada)</label>
                <input type="date" name="date_end" id="date_end" 
                       value="{{ request.GET.date_end }}" 
                       onchange="this.form.submit()">
            </div>
            
            <div class="filter-group">
                <select name="cliente" id="filter_client" onchange="this.form.submit()">
                    <option value="Todos">Cliente - Todos</option>
                    {% for c in clientes_filtro %}
                        <option value="{{ c.ClienteID }}" {% if request.GET.cliente == c.ClienteID|stringformat:"s" %}selected{% endif %}>
                            {{ c.NombreComercial }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
        </div>

        <div class="filter-row" style="margin-bottom: 0;">
            <div class="filter-group">
                <select name="servicio" onchange="this.form.submit()">
                    <option value="Todos">Servicio - Todos</option>
                    <option value="Mantenimiento" {% if request.GET.servicio == 'Mantenimiento' %}selected{% endif %}>Mantenimiento</option>
                    <option value="Revisión" {% if request.GET.servicio == 'Revisión' %}selected{% endif %}>Revisión</option>
                    <option value="Reparación" {% if request.GET.servicio == 'Reparación' %}selected{% endif %}>Reparación</option>
                    <option value="Instalación" {% if request.GET.servicio == 'Instalación' %}selected{% endif %}>Instalación</option>
                </select>
            </div>
            
            <div class="filter-group">
                <select name="estado" onchange="this.form.submit()">
                    <option value="Todos">Estado - Todos</option>
                    <option value="Pendiente" {% if request.GET.estado == 'Pendiente' %}selected{% endif %}>Pendiente</option>
                    <option value="Terminada" {% if request.GET.estado == 'Terminada' %}selected{% endif %}>Terminada</option>
                </select>
            </div>
            
            <div class="filter-group">
                <select name="personal" onchange="this.form.submit()">
                    <option value="Todos">Personal - Todos</option>
                    {% for t in tecnicos_filtro %}
                        <option value="{{ t.UsuarioID }}" {% if request.GET.personal == t.UsuarioID|stringformat:"s" %}selected{% endif %}>
                            {{ t.Nombre }} {{ t.Apellido }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </div>

    </form>
</div>

                <div class="action-toolbar">
                    <div class="action-toolbar-left">
                        <label>Mostrar</label>
                        <select>
                            <option>15</option>
                            <option>30</option>
                            <option>50</option>
                        </select>
                        <label>registros</label>
                    </div>
<div class="action-toolbar-right">
{% if request.user.Rol == 'Administrador' %}
 <button id="btn_nueva_orden"><i class="fas fa-plus-circle"></i> Nueva Orden</button>
 <button id="btn_xls"><i class="fas fa-file-excel"></i> XLS</button>
 <button id="btn_print"><i class="fas fa-print"></i></button>
 {% endif %}
 <div class="search-box">
    <i class="fas fa-search"></i>
    <form method="GET" action="{% url 'lista_ordenes' %}" style="width: 100%;">
        <input type="text" name="q" placeholder="Buscar cliente, folio..." 
               value="{{ request.GET.q }}" 
               style="border: none; outline: none; width: 100%;"
               aria-label="Buscar">
    </form>
</div>
                    </div>
                </div>

                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="width: 40px;"></th>
                                <th style="width: 80px;">Folio</th>
                                <th style="width: 110px;">Programada <i class="fas fa-sort"></i></th>
                                <th style="width: 80px;">Inicio</th>
                                <th style="width: 80px;">Fin</th>
                                <th style="width: 170px;">Cliente</th>
                                <th style="width: 150px;">Personal</th>
                                <th style="width: 80px;">Prioridad</th>
                                <th style="width: 90px;">Estado</th>
                                <th style="width: 40px;">PDF</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for orden in lista_de_ordenes %}
                        <tr>
<td class="action-cell" style="white-space: nowrap;">
 <div class="flex items-center justify-center gap-3">

{% if request.user.Rol == 'Administrador' %}

    <a href="{% url 'editar_orden' orden.OrdenID %}" 
    class="text-blue-500 hover:text-blue-700 transition-colors" 
   title="Editar Orden">
    <i class="fas fa-pen"></i>
    </a>

  <form action="{% url 'eliminar_orden' orden.OrdenID %}" method="POST" class="inline">
     {% csrf_token %}
     <button type="submit" 
    class="text-slate-300 hover:text-red-500 transition-colors" 
    title="Eliminar Orden"
    onclick="return confirm('¿Estás seguro de eliminar la Orden #{{ orden.OrdenID }}?');">
        <i class="fas fa-trash-alt"></i>
    </button>
     </form>

 {% endif %}
</div>
</td>
                            <td class="folio-cell">{{ orden.OrdenID }}</td>
                            <td>
                                {{ orden.Programada|date:"d/m/Y" }} 
                                <span class="servicio-text">{{ orden.Programada|date:"H:i" }}</span>
                            </td>
                            <td>{{ orden.Inicio|time:"H:i"|default:"--" }}</td> <td>{{ orden.Fin|time:"H:i"|default:"--" }}</td>    
                            <td class="cliente-cell">
                                {{ orden.ClienteEmpresa.NombreComercial|default:"(Sin Cliente)" }} 
                                <span class="servicio-text">{{ orden.Servicio|default:""|upper }}</span>
                            </td>
                            <td>
                                {{ orden.PersonalAsignado.Nombre|default:"" }} {{ orden.PersonalAsignado.Apellido|default:"" }}
                            </td>
                            <td>{{ orden.Prioridad|default:"Normal" }}</td> 
                            <td>
                                {% if orden.Estado == 'Terminada' %}
                                    <span class="status-tag status-terminada">{{ orden.Estado }}</span>
                                {% elif orden.Estado == 'Pendiente' %}
                                    <span class="status-tag status-pendiente">{{ orden.Estado }}</span>
                                {% else %}
                                    <span class="status-tag">{{ orden.Estado|default:"N/A" }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if orden.Estado == 'Completada' or orden.Estado == 'Terminada' %}
                                    <a href="{% url 'ver_reporte' orden.pk %}" class="pdf-download-btn" target="_blank" title="Ver Reporte">
                                        <i class="fas fa-download"></i>
                                    </a>
                                {% else %}
                                    <button class="pdf-download-btn" disabled style="opacity: 0.3; cursor: not-allowed;" title="Reporte no disponible">
                                        <i class="fas fa-download"></i>
                                    </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="10" style="text-align: center; padding: 20px;">No hay órdenes de servicio registradas.</td>
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div id="nuevaOrdenModal" class="modal" {% if form_orden.errors %}style="display: block;"{% endif %}>
        <div class="modal-content">
            <form method="POST" action="{% if orden_a_editar %}{% url 'editar_orden' orden_a_editar.OrdenID %}{% else %}{% url 'lista_ordenes' %}{% endif %}">
                {% csrf_token %}

                <div class="modal-body">
                    <div class="form-section">
                        <div class="card">
                            <h2 style="text-align: center; font-weight: 800; color: #333; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px;">
        DATOS GENERALES
    </h2>
                            <div class="form-grid">

                                <div class="form-group">
                                    <label for="{{ form_orden.ClienteEmpresa.id_for_label }}">Cliente / Empresa *</label>
                                    {{ form_orden.ClienteEmpresa }}
                                    {% if form_orden.ClienteEmpresa.errors %}
                                        <div style="color: red; font-size: 0.8em;">{{ form_orden.ClienteEmpresa.errors }}</div>
                                    {% endif %}
                                </div>

                                <div class="form-group">
                                    <label for="{{ form_orden.TelefonoContacto.id_for_label }}">Teléfono</label>
                                    {{ form_orden.TelefonoContacto }}
                                </div>

                                <div class="form-group">
                                    <label for="{{ form_orden.EmailContacto.id_for_label }}">Email</label>
                                    {{ form_orden.EmailContacto }}
                                </div>

                                <div class="form-group">
                                    <label for="{{ form_orden.Servicio.id_for_label }}">Servicio *</label>
                                    {{ form_orden.Servicio }}
                                </div>

                                <div class="form-group">
                                    <label for="{{ form_orden.PersonalAsignado.id_for_label }}">Personal asignado *</label>
                                    {{ form_orden.PersonalAsignado }}
                                </div>

                                <div class="form-group">
                                    <label for="{{ form_orden.Giro.id_for_label }}">Giro *</label>
                                    {{ form_orden.Giro }}
                                </div>

                                <div class="form-group full-width">
                                    <label for="{{ form_orden.Ubicacion.id_for_label }}">Ubicación (Link de Google Maps) *</label>
                                    
                                    <div style="display: flex; gap: 10px; align-items: center;">
                                        <input type="text" 
       id="{{ form_orden.Ubicacion.id_for_label }}" 
       name="{{ form_orden.Ubicacion.name }}" 
       class="form-control"
       readonly
       required  style="flex: 1; color: #007bff; text-decoration: underline; cursor: pointer; background-color: #f8f9fa;"
       value="{{ form_orden.instance.Ubicacion|default:'' }}"
       style="flex: 1; color: #007bff; text-decoration: underline; cursor: pointer; background-color: #f8f9fa;"
       placeholder="Selecciona un cliente para cargar la ubicación..."
       onclick="if(this.value.startsWith('http')) { window.open(this.value, '_blank'); }">

                                        <a id="btn_ir_maps" href="#" target="_blank" class="btn btn-outline" 
                                           style="text-decoration: none; white-space: nowrap; height: 38px; display: flex; align-items: center; padding: 0 15px; border: 1px solid #ccc; border-radius: 4px; color: #333;">
                                            <i class="fas fa-map-marked-alt" style="margin-right: 8px; color: #007bff;"></i> Ir a Maps
                                        </a>
                                    </div>
                                </div>

                                <div class="form-group full-width">
                                    <label for="{{ form_orden.FallaReportada.id_for_label }}">Falla reportada</label>
                                    {{ form_orden.FallaReportada }}
                                </div>

                                <div class="form-group">
                                    <label for="{{ form_orden.Programada.id_for_label }}">Programada *</label>
                                    {{ form_orden.Programada }}
                                    {% if form_orden.Programada.errors %}
                                        <div style="color: red; font-size: 0.8em;">{{ form_orden.Programada.errors }}</div>
                                    {% endif %}
                                </div>

                                <div class="form-group">
                                    <label for="{{ form_orden.Precio.id_for_label }}">Precio $</label>
                                    {{ form_orden.Precio }}
                                </div>

                            </div> 
                        </div> 
                        
                        <div class="card add-item-section">
                            <div class="form-group">
                                <label for="detalle_cantidad">Cant</label>
                                <input type="number" id="detalle_cantidad" value="1"> 
                            </div>
                            <div class="form-group">
                                <label for="detalle_producto">Productos</label>
                                <textarea id="detalle_producto" rows="1"></textarea> 
                            </div>
                            <div class="form-group">
                                <label for="detalle_info">Información adicional</label>
                                <input type="text" id="detalle_info"> 
                            </div>
                            <button type="button" class="btn btn-primary" id="btn_agregar_producto">Agregar</button> 
                        </div>

                        <div class="card">
                            <h2><i class="fas fa-box"></i> Productos - Refacciones - Materiales</h2>
                            <div id="lista_productos_agregados" style="margin-top: 15px;">
                                <p style="color: #6c757d;">Aún no se han agregado productos.</p> 
                            </div>
                        </div>

                    </div> 
                    <div class="actions-section">
                        <div class="card actions-card">
                            <h2 style="text-align: center; font-weight: 800; color: #333; margin-bottom: 20px;">ORDEN DE SERVICIO</h2>
                            <div class="info-header">
                                <i class="fas fa-calendar-day"></i>
                                <div class="date">{{ "now"|date:"d/m/Y" }}</div> 
                            </div>
<div class="info-tags">
    <span>(Servicio Técnico)</span> &bull; 
    <span style="font-weight: bold; color: var(--primary-color);">
        {% if orden_a_editar %}
            EDICIÓN FOLIO #{{ orden_a_editar.OrdenID }}
        {% else %}
            NUEVO FOLIO #{{ lista_de_ordenes.count|add:1 }}
        {% endif %}
    </span>
</div>
                            <input type="hidden" name="Estado" value="Pendiente">

                            <div class="action-buttons">
                                <button type="submit" class="btn btn-primary">
    {% if orden_a_editar %}
        <i class="fas fa-sync-alt"></i> Actualizar Orden
    {% else %}
        <i class="fas fa-save"></i> Guardar Orden
    {% endif %}
</button>
                                <button type="button" id="btn_limpiar" class="btn btn-success">
    {% if orden_a_editar %}
        <i class="fas fa-undo"></i> Deshacer
    {% else %}
        <i class="fas fa-eraser"></i> Limpiar
    {% endif %}
</button>
                                <button type="button" class="btn btn-outline" id="btn_salir_modal">Salir</button> 
                            </div>
                        </div>
                    </div> 
                </div> 
            </form> 
        </div> 
    </div> 
<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log("DOM Cargado - Gestión de Órdenes (Versión Final)");

        // =========================================================
        // 0. VARIABLES GLOBALES
        // =========================================================
        const modalNuevaOrden = document.getElementById('nuevaOrdenModal');
        const btnAbrirNuevaOrden = document.getElementById('btn_nueva_orden');
        const btnSalirNuevaOrden = document.getElementById('btn_salir_modal');
        const btnLimpiar = document.getElementById('btn_limpiar');
        
        const clienteSelect = document.getElementById('{{ form_orden.ClienteEmpresa.id_for_label }}');
        const telefonoInput = document.getElementById('{{ form_orden.TelefonoContacto.id_for_label }}');
        const emailInput = document.getElementById('{{ form_orden.EmailContacto.id_for_label }}');
        const ubicacionInput = document.getElementById('{{ form_orden.Ubicacion.id_for_label }}');
        const btnIrMaps = document.getElementById('btn_ir_maps'); 

        const btnAgregar = document.getElementById('btn_agregar_producto');
        const listaProductosDiv = document.getElementById('lista_productos_agregados');
        const inputCantidad = document.getElementById('detalle_cantidad');
        const inputProducto = document.getElementById('detalle_producto');
        const inputInfo = document.getElementById('detalle_info');
        let placeholderProductos = null;
        let productosOriginales = []; 

        // =========================================================
        // 1. FUNCIONES DE AYUDA
        // =========================================================
        function crearFilaProducto(cantidad, producto, info) {
            const div = document.createElement('div');
            div.style.borderBottom = '1px solid #eee';
            div.style.padding = '8px 0';
            div.style.marginBottom = '8px';
            div.style.display = 'flex';
            div.style.justifyContent = 'space-between';
            div.style.alignItems = 'center';

            div.innerHTML = `
                <span>
                    <strong>${cantidad} x ${producto}</strong> 
                    ${info ? '<br><small style="color:#6c757d;">'+info+'</small>' : ''}
                </span>
                <span>
                    <input type="hidden" name="detalle_cantidad[]" value="${cantidad}">
                    <input type="hidden" name="detalle_producto[]" value="${producto}">
                    <input type="hidden" name="detalle_info[]" value="${info}">
                    <button type="button" class="btn-remove-producto" style="background:none; border:none; color:#dc3545; cursor:pointer; font-size: 1.2em;" title="Quitar">&times;</button>
                </span>
            `;
            div.querySelector('.btn-remove-producto').addEventListener('click', function() {
                div.remove();
                verificarPlaceholder();
            });
            return div;
        }

        function verificarPlaceholder() {
            if (listaProductosDiv.querySelectorAll('div').length === 0) {
                if (!placeholderProductos) {
                    placeholderProductos = document.createElement('p');
                    placeholderProductos.style.color = '#6c757d';
                    placeholderProductos.textContent = 'Aún no se han agregado productos.';
                    listaProductosDiv.appendChild(placeholderProductos);
                }
                placeholderProductos.style.display = 'block';
            } else {
                if (placeholderProductos) placeholderProductos.style.display = 'none';
            }
        }

        function limpiarListaProductos() {
            if(listaProductosDiv) {
                listaProductosDiv.innerHTML = '';
                placeholderProductos = document.createElement('p');
                placeholderProductos.style.color = '#6c757d';
                placeholderProductos.innerText = 'Aún no se han agregado productos.';
                listaProductosDiv.appendChild(placeholderProductos);
                placeholderProductos.style.display = 'block';
            }
        }

        function restaurarProductosDesdeMemoria() {
            limpiarListaProductos();
            productosOriginales.forEach(item => {
                const fila = crearFilaProducto(item.cantidad, item.producto, item.info);
                listaProductosDiv.appendChild(fila);
            });
            verificarPlaceholder();
        }

        function actualizarBotonMaps(link) {
            if(ubicacionInput) ubicacionInput.value = link;
            if (btnIrMaps) {
                if (link && link.startsWith('http')) {
                    btnIrMaps.href = link;
                    btnIrMaps.classList.remove('disabled');
                    btnIrMaps.style.pointerEvents = 'auto';
                    btnIrMaps.style.opacity = '1';
                } else {
                    btnIrMaps.href = '#';
                    btnIrMaps.classList.add('disabled');
                    btnIrMaps.style.pointerEvents = 'none';
                    btnIrMaps.style.opacity = '0.5';
                }
            }
        }

        // =========================================================
        // 2. AUTOCOMPLETAR
        // =========================================================
        if (clienteSelect) {
            clienteSelect.addEventListener('change', function() {
                const clienteId = this.value;
                if (!clienteId) {
                    if(telefonoInput) telefonoInput.value = '';
                    if(emailInput) emailInput.value = '';
                    actualizarBotonMaps('');
                    return;
                }
                fetch(`/api/get_client_details/${clienteId}/`)
                .then(response => response.json())
                .then(data => {
                    if(telefonoInput) telefonoInput.value = data.telefono || '';
                    if(emailInput) emailInput.value = data.email || '';
                    actualizarBotonMaps(data.ubicacion || '');
                })
                .catch(console.error);
            });
        }

        // =========================================================
        // 3. AGREGAR PRODUCTOS
        // =========================================================
        if (btnAgregar) {
            btnAgregar.onclick = () => {
                const cant = inputCantidad.value.trim() || '1';
                const prod = inputProducto.value.trim();
                const info = inputInfo.value.trim();

                if (!prod) {
                    alert('Ingresa el nombre del producto');
                    inputProducto.focus();
                    return;
                }
                listaProductosDiv.appendChild(crearFilaProducto(cant, prod, info));
                verificarPlaceholder();
                inputCantidad.value = '1';
                inputProducto.value = '';
                inputInfo.value = '';
                inputProducto.focus();
            }
        }

        // =========================================================
        // 4. MODAL Y NAVEGACIÓN
        // =========================================================
        if (btnAbrirNuevaOrden) {
            btnAbrirNuevaOrden.onclick = (e) => {
                e.preventDefault();
                if (window.location.href.includes('/editar/')) {
                    window.location.href = "{% url 'lista_ordenes' %}";
                    return;
                }
                const form = document.querySelector('#nuevaOrdenModal form');
                if(form) form.reset(); 
                limpiarListaProductos();
                actualizarBotonMaps('');
                productosOriginales = []; 
                modalNuevaOrden.style.display = 'block';
            }
        }
        
        if (btnSalirNuevaOrden) {
            btnSalirNuevaOrden.onclick = () => {
                modalNuevaOrden.style.display = 'none';
                if (window.location.href.includes('/editar/')) {
                    window.location.href = "{% url 'lista_ordenes' %}";
                }
            }
        }

        window.onclick = (event) => {
            if (event.target == modalNuevaOrden) {
                modalNuevaOrden.style.display = 'none';
                if (window.location.href.includes('/editar/')) {
                    window.location.href = "{% url 'lista_ordenes' %}";
                }
            }
        }

        // =========================================================
        // 5. BOTÓN LIMPIAR (INTELIGENTE)
        // =========================================================
        if (btnLimpiar) {
            btnLimpiar.onclick = () => {
                const form = document.querySelector('#nuevaOrdenModal form');
                const esEdicion = window.location.href.includes('/editar/');

                if (esEdicion) {
                    // DESHACER
                    if(form) form.reset();
                    setTimeout(() => { actualizarBotonMaps(ubicacionInput.value); }, 50);
                    restaurarProductosDesdeMemoria();
                } else {
                    // LIMPIAR TODO
                    if(form) {
                        form.querySelectorAll('input:not([type=hidden]), textarea').forEach(i => i.value = '');
                        form.querySelectorAll('select').forEach(s => s.selectedIndex = 0);
                    }
                    actualizarBotonMaps('');
                    limpiarListaProductos();
                }
                if(inputCantidad) inputCantidad.value = '1';
                if(inputProducto) inputProducto.value = '';
                if(inputInfo) inputInfo.value = '';
            }
        }

        // =========================================================
        // 6. INICIALIZACIÓN AUTOMÁTICA AL EDITAR
        // =========================================================
        {% if abrir_modal %}
            if (modalNuevaOrden) {
                modalNuevaOrden.style.display = 'block';
                const valUbicacion = ubicacionInput ? ubicacionInput.value : '';
                actualizarBotonMaps(valUbicacion);

                limpiarListaProductos();
                productosOriginales = [];

                {% for detalle in orden_a_editar.ordendetalles_set.all %}
                    productosOriginales.push({
                        cantidad: "{{ detalle.Cantidad }}",
                        producto: "{{ detalle.Producto|escapejs }}",
                        info: "{{ detalle.InformacionAdicional|default:''|escapejs }}"
                    });
                    var filaDB = crearFilaProducto(
                        "{{ detalle.Cantidad }}", 
                        "{{ detalle.Producto|escapejs }}", 
                        "{{ detalle.InformacionAdicional|default:''|escapejs }}"
                    );
                    listaProductosDiv.appendChild(filaDB);
                {% endfor %}
                
                verificarPlaceholder();
            }
        {% endif %}

        // =========================================================
        // 7. VALIDACIONES DE GUARDADO (CORREGIDO)
        // =========================================================
        const camposObligatoriosIds = [
            '{{ form_orden.ClienteEmpresa.id_for_label }}',
            '{{ form_orden.Servicio.id_for_label }}',
            '{{ form_orden.PersonalAsignado.id_for_label }}',
            '{{ form_orden.Giro.id_for_label }}',
            '{{ form_orden.Programada.id_for_label }}',
            '{{ form_orden.Precio.id_for_label }}',
            '{{ form_orden.FallaReportada.id_for_label }}'
        ];

        camposObligatoriosIds.forEach(id => {
            const elemento = document.getElementById(id);
            if (elemento) elemento.required = true;
        });

        const formularioOrden = document.querySelector('#nuevaOrdenModal form');
        if (formularioOrden) {
            formularioOrden.addEventListener('submit', function(event) {
                const numProductos = listaProductosDiv.querySelectorAll('div').length;
                if (numProductos === 0) {
                    event.preventDefault();
                    alert('⚠️ No puedes guardar una orden vacía.\n\nPor favor, agrega al menos un producto.');
                    if(inputProducto) inputProducto.focus();
                }
            });
        }

    }); 
</script>
</body>
</html>